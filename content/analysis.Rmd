---
title: Analysis
description:
toc: true
featuredVideo:
featuredImage: https://i0.wp.com/reflectionsonbaseball.com/wp-content/uploads/2020/01/mlbnba.png?fit=604%2C323&ssl=1
draft: false
---

## Rubric: On this page


you will

* Introduce what motivates your Data Analysis (DA)
  * Which variables and relationships are you most interested in?
  * What questions are you interested in answering?
* Breadth of the DA
  * Make sure that you ask enough initial questions to explore the different variables in your data.
  * i.e. Do you explore more than just one or two variables? Do you explore a few different relationships or many?
* Depth of the DA
  * When you answer one question, usually more questions arise as well. 
  * The depth of the DA is about coming up with and exploring the answers to these questions, often iterating the process a few times.
* Modeling and Inference 
  * You should also include some kind of formal statistical model and/or inference. This could be a linear regression, logistic regression, hypothesis testing etc.
  * Explain the techniques you used for validating your results.
  * Describe the results of your modelling and make sure to give a sense of the uncertainty in your estimates and conclusions.
* Explain the flaws and limitations of your analysis
  * Are there some assumptions that you needed to make that might not hold? Is there other data that would help to answer your questions? ...
* Clarity Figures
  * Are your figures/tables/results easy to read, informative, without problems like overplotting, hard-to-read labels, etc?
  * Each figure should provide a key insight. Too many figures or other data summaries can detract from this.
* Clarity of Explanations
  * Do you introduce why you are doing each analysis?
  * How well do you explain each figure/result?
  * Do you provide interpretations that suggest further analysis or explanations for observed phenomenon?
* Organization and cleanliness.
  * Make sure to remove excessive warnings, use clean easy-to-read code, organize with sections or multiple pages, use bullets, etc.
  
  
**NOTE**: Your Data Analysis can be broken up into multiple pages if that helps with your organization.

<<<<<<< HEAD
* Introduce what motivates your Data Analysis (DA)
  * Which variables and relationships are you most interested in?
  * What questions are you interested in answering?
  
What motivates our analysis is a desire to examine our relationship between trends in both the MLB and NBA, and see what comparisons we can draw between the two leagues, especially in regards to player streakiness. The main variables that we are interested in analyzing are hits, walks, and strikeouts in the MLB, and points,rebounds, and assists in the NBA


=======

## Goals:

Here we aim to detail our explarotary data analysis on both the NBA and MLB data.

## NBA EDA:

## Identifying Streaks:

For the NBA data, we first wanted to identify the longest streaks in the NBA. This would help us get a sense of which players had the longest streaks for a particular statistic in the league in a given season. The first statistic to look at was points. To assess the longest scoring streaks in the league, we had to calculate the points per season for each player. As stated in the Data page, the dataset had game-by-game data for each player, but did not account for entire season statistics. This meant that some cleaning and calculations were necessary. First, as stated in the Data page, any erroneous extra rows were removed. This provided the appropriate amount of games played by each player. Then the season average in points scored was caclulated by dividing the total points scored by the total number of games played for each player, respectively. The field goal percentage was also calculated by dividing the total number of field goal made by the total number offield goal attempts. As seen in the table below, the table now listed the season points and field goal average, grouped by each player. Similarly, the assists and rebounds per game were also calculated. 


```{r nbadata}
library(tidyverse)

nba_data22 <- read.csv(file = '../dataset/ASA All NBA Raw Data 2022 regular season.csv')

nba_ppg22 <- group_by(nba_data22, player) %>%
  filter(mp != '0:00') %>%
  distinct(game_date, .keep_all = TRUE) %>%
  summarize(total_games = n(),
            ppg = sum(pts)/total_games,
            fg_percentage = sum(fg)/sum(fga),
            apg = sum(ast)/total_games,
            rpg = sum(trb)/total_games)

print(nba_ppg22 %>% head(10))

```

We wanted to take a look at the most efficient scorers amongst the top scorers. Temporarily setting a threshold for players who scored at least 20 points per game, we made a scatterplot that visualized this relationship to get a sense of who we might expect to have the longest streaks, seen below. 



```{r eval=FALSE, include=TRUE}

scoring <- filter(nba_ppg22, ppg >= 25)

ggplot(scoring, aes(x=fg_percentage, y=ppg, label=player)) +
  geom_point() +
  geom_text(hjust=0, vjust=0) + 
  ggtitle("25+ PPG Scorers Against Field Goal Percentage")


```
``` {r 25pt_vs_fg}
# To Prevent Needing to Rerun EDA Each Time
knitr::include_graphics('analysis_files/figure-html/Rplot01.png')
```

We see above that Lebron James and Joel Embiid scored the most points in the 2022 season, and that they were among the most efficient players in this pool, alongside Giannis Antetokounmpo, Nikola Jokic, and Kevin Durant. Because of their prolific and efficient scoring, we at first expected them to be the among the players with the longest streaks. However, because of their consistancy, it was instead hypothesized that the streakiest players, and therefore the players with the longest streaks, would be those with a lower usage rates and lower scoring - possibly role players who were infrequently given a chances to score above their usual means. 

Because we score streaks based on the individual game performance AGAINST their season average, we needed to join the calculated season averages to the entire game-by-game data, as shown below. Additionally, in this merged dataset, we calculated the deviation per game for each of the three following statistics: points, assists, and rebounds. The deviation was calculated as the statistic from one game substracted by that player's season average in that statistic. For example, 5 `pts` scored in one game substracted from 10 `ppg` will result in a `deviationppg` of -5. 

```{r nba merge}

merged2022 <- nba_ppg22 %>% inner_join(nba_data22, by="player") %>%
  filter(mp != '0:00') %>%
  group_by(player) %>%
  distinct(game_date, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(date = as.Date(game_date, format = "%Y-%m-%d")) %>%
  mutate(deviationppg = pts-ppg,
         deviationapg = ast-apg,
         deviationrpg = trb-rpg) %>%
  arrange(player, date)


```

The next step was to actually find the streaks. For this, we downloaded the package `data.table`. This assisted us in finding the longest consecutive strings of consecutive games for each statistic. Using points as an example, if a player had a game with a positive `deviationppg`, the `positive_dev_ppg` will be 1. This column is tracked by the `Consec_ppg` column, which increases by 1 each time a player has a positive deviation in a consecutive game. We accounted for each player, grouping by player within this function to ensure that the streaks don't overlap players by mistake. We also took this opportunity to find the number of games played by a player in the season. This allows us to plot using game number instead of game date for more consistency. 


```{r nba streaks}

library(data.table)

streaks2022 <- merged2022

setDT(streaks2022)

streaks2022[, positive_dev_ppg := +(deviationppg > 0)
][positive_dev_ppg == 0]

streaks2022[, positive_dev_apg := +(deviationapg > 0)
][positive_dev_apg == 0]

streaks2022[, positive_dev_rpg := +(deviationrpg > 0)
][positive_dev_rpg == 0]

streaks2022[, Consec_ppg := ifelse(positive_dev_ppg == 1, 1:.N, 0L), by = rleid(positive_dev_ppg == 1, player)]

streaks2022[, Consec_apg := ifelse(positive_dev_apg == 1, 1:.N, 0L), by = rleid(positive_dev_apg == 1, player)]

streaks2022[, Consec_rpg := ifelse(positive_dev_rpg == 1, 1:.N, 0L), by = rleid(positive_dev_rpg == 1, player)]

streaks2022[, game_number := ifelse(positive_dev_ppg == 1 | positive_dev_ppg == 0, 1:.N, 0L), by = rleid(player)]

print(streaks2022 %>% 
  select(player, date, ppg, pts, deviationppg, positive_dev_ppg, Consec_ppg, apg, ast, deviationapg, positive_dev_apg, Consec_apg, rpg, trb, deviationrpg, positive_dev_rpg, Consec_rpg, game_number) %>% head(10))



```

The above table shows the first 10 rows in the `streaks2022` dataset, showing the way the streaks were counted. Using this table, we could now see the players with the longest streaks.

```{r nba ppgstreak}

streaks2022 %>%
  group_by(player) %>%
  summarize(max_streak = max(Consec_ppg)) %>%
  select(player, max_streak) %>% 
  arrange(-max_streak) %>%
  head(10)


```

As previously theorized, we were able to find that the players with the longest streaks were those that were role players. Only one player in the top 10 longest streaks scored over 20 points per game. This would agree with the idea that a longer streak would most likely be accomplished by a player with a lower season average, as a player could be given an opportunity, or go on a 'hot streak' to perform above their usual output.

```{r nba 20ppgstreak}

streaks2022 %>% 
  filter(ppg >= 20) %>%
  group_by(player) %>%
  summarize(max_streak = max(Consec_ppg)) %>%
  select(player, max_streak) %>% 
  arrange(-max_streak) %>% 
  head(10)


```

Even among the best players, scoring over 20 points per game, the majority of players in the top 10 were those scoring in the low 20s. This again fortifies the theory that players who score prolifically in a season are usually less likely to go on streaks, as they are much more consistent and deviate much less significantly or less frequently.

## Flaws/Limitations:

One of the main flaws in this analysis are the innate differences of basketball and baseball in both offensive and defensive aspects of the game. Baseball, especially when on offense, is a more individualistic game, whereas basketball relies heavily on the entire team. When a player is batting, their only objective is to hit the ball, while a basketball player may have to pass, changing the potential outcome, especially for those players with high usage rate. These innate differences cause difficulty when trying to make a 1:1 assessment between the two leagues.  

##MLB Broad Analysis

To generalize the concept of “streakiness” in MLB, we wanted to find out if there was one single stat that could most strongly predict whether a batter is streaky or not. The following is most of the data cleaning for this analysis:

```{r eval=FALSE, include=TRUE}
library(tidyverse)
library(modelr)
library(ggrepel)

stat_fct <- function(x,y){
  ifelse(y > 0, x/y, 0)
}

bat_data_21 <- read_csv("dataset/MLB_bat_data_2021.csv") %>%
  filter(pa > 0) %>%
  select(-game_id, -player_id, -details, -batting_order, -DKP, -FDP, -SDP) %>%
  mutate(singles = h - (doubles + triples + home_runs),
         tb = singles + 2*doubles + 3*triples + 4*home_runs,
         on_base = h + bb + hit_by_pitch) %>%
  arrange(player, game_date)

ops_data_21 <- bat_data_21 %>% group_by(player) %>%
  summarize(ab = sum(ab),
            pa = sum(pa),
            tb = sum(tb),
            on_base = sum(on_base)) %>% 
  mutate(obp = stat_fct(on_base, pa), slg = stat_fct(tb, ab),
         ops = obp + slg) %>% select(player, obp, slg, ops)

MLB_avg_21 <- bat_data_21 %>%
  summarize(ab = sum(ab),
            pa = sum(pa),
            tb = sum(tb),
            on_base = sum(on_base)) %>% 
  mutate(obp = stat_fct(on_base, pa), slg = stat_fct(tb, ab),
         ops = obp + slg) %>% select(obp, slg, ops)

bat_data_day_21 <- left_join(bat_data_21, ops_data_21, by = "player") %>%
  mutate(MLB_diff = MLB_avg_21$ops - ops)

sim_21 <- bat_data_day_21 %>% group_by(player) %>% filter(sum(pa) >= 500) %>%
  group_by(game_date) %>%
  mutate(obp_game = stat_fct(on_base, pa),
         slg_game = stat_fct(tb, ab),
         ops_game = obp_game + slg_game,
         ops_diff = ops_game - MLB_avg_21$ops,
         above = (ops_diff > 0)) %>% ungroup() %>% group_by(player) %>%
  summarize(games_above = sum(above), games = n(), per = games_above/games,
            ops = mean(ops), pa = sum(pa), home_runs = sum(home_runs),
            bb = sum(bb), so = sum(so))

model_21 <- lm(per ~ ops, data = sim_21)
beta <- coef(model_21)
summary(model_21)
ggplot(sim_21, aes(ops, per)) + geom_point() +
  geom_abline(intercept = beta[1], slope = beta[2], color = "red") +
  labs(x = "OPS", y = "% of Games Above League Average")

s_res_21 <- rstandard(model_21)
sim_21 %>% cbind(s_res_21) %>%  ggplot(aes(ops, s_res_21)) +
  geom_ref_line(h = 0) + geom_point()

log_sim_21 <- sim_21 %>% cbind(s_res_21) %>%
  mutate(streaky = ifelse(s_res_21 < 0, 1, 0))
```

The stat to determine a player’s value in this analysis is OPS. We then calculated among players with at least 500 plate appearances the percentage of their games where they recorded an OPS above the league average of .726 and plotted it against their total OPS for the season. Intuitively, we would expect players with higher overall OPS to have a higher percentage of games where they performed above league average, and that’s what we see here:

```{r echo=FALSE}
model_21 <- lm(per ~ ops, data = sim_21)
beta <- coef(model_21)
summary(model_21)
ggplot(sim_21, aes(ops, per)) + geom_point() +
  geom_abline(intercept = beta[1], slope = beta[2], color = "red") +
  labs(x = "OPS", y = "% of Games Above League Average")
```

Fitting a linear regression to this data, we find a statistically significant correlation. For our step, we standardized the residuals and determined that players with high magnitude positive residuals were the most “consistent,” and ones with high magnitude negative residuals were the most “streaky.” Why is this? We would expect more streaky players to have a small number of games with big production and a large number of below average games.

To visualize this decision, here’s a game log of Jose Altuve, who is the most consistent player by our residual measure. The graph represents games where performed above or below his OWN average OPS, and the red line represents the MLB average:

```{r echo=FALSE}
bat_data_day_21 %>% filter(player == "Jose Altuve") %>%
  group_by(game_date) %>%
  mutate(obp_game = stat_fct(on_base, pa),
         slg_game = stat_fct(tb, ab),
         ops_game = obp_game + slg_game,
         ops_diff = ops_game - ops,
         sign = sign(ops_diff)) %>%
  ggplot() +
  geom_col(aes(game_date, ops_diff, fill = sign), position = "identity",
           show.legend = FALSE) +
  geom_line(aes(game_date, mean(MLB_diff)), color = "red") +
  labs(title = "Jose Altuve Game by Game OPS Data",
       x = "Date", y = "Game OPS compared to average")
```

And here’s a game of log of Nathaniel Lowe, who is the most streaky player:

```{r echo=FALSE}
bat_data_day_21 %>% filter(player == "Nathaniel Lowe") %>%
  group_by(game_date) %>%
  mutate(obp_game = stat_fct(on_base, pa),
         slg_game = stat_fct(tb, ab),
         ops_game = obp_game + slg_game,
         ops_diff = ops_game - ops,
         sign = sign(ops_diff)) %>%
  ggplot() +
  geom_col(aes(game_date, ops_diff, fill = sign), position = "identity",
           show.legend = FALSE) +
  geom_line(aes(game_date, mean(MLB_diff)), color = "red") +
  labs(title = "Nathaniel Lowe Game by Game OPS Data",
       x = "Date", y = "Game OPS compared to average")
```

Now we turned to analyze if there was a single stat that could most accurately predict whether a player was streaky or not. At first, we thought that walks would be the best stat, because of the idea that some players are “free swingers;” players that swing at a ton of pitches, don’t draw many walks, but are still on the roster because of their ability to get hot at certain times. However, walks ended up not being a great predictor. We also tried home runs, but that wasn’t a great predictor either.

Out of all stats we tried, strikeouts was the best predictor as seen by this linear regression:

```{r echo=FALSE}
lm_so <- lm(s_res_21 ~ so, data = log_sim_21)
bt_so <- coef(lm_so)
summary(lm_so)
ggplot(log_sim_21, aes(so, s_res_21)) + geom_point() +
  geom_abline(intercept = bt_so[1], slope = bt_so[2], color = "red") +
  labs(x = "Strikeouts", y = "Streakiness (Residual)")
```

As well as this logistic regression, where we labeled players as streaky or consistent by the SIGN of their residuals:

```{r echo=FALSE}
log_model_so <- glm(streaky ~ so, data = log_sim_21, family = binomial)
beta_so <- coef(log_model_so)
grid_so <- log_sim_21 %>% data_grid(so) %>%
    add_predictions(log_model_so, type = "response")
summary(log_model_so)
ggplot(log_sim_21, aes(so)) + geom_point(aes(y = streaky)) +
  geom_line(aes(y = pred), data = grid_so, color = "red", size = 1) +
  labs(x = "Strikeouts", y = "Streakiness (Binomial)")
```

So we conclude that “free swingers” are not necessarily the streaky players, but rather the “swing for the fences” type of players, meaning players that swing as hard as they can as much as they can in order to hit more home runs, but at the cost of striking out more. It is also interesting to note how strikeouts were correlated to streakiness in a statistically significant way but not home runs, meaning the act of “swinging for the fences” relates to streakiness whether or not the players are actually successful in hitting more home runs.

There are some limitations to this analysis. It generalizes streakiness as a concept to a great degree, and does not cover game-to-game streaks. We also performed a different analysis of streaks in MLB to cover for these shortcomings, and used that analysis to tie in similarities to our NBA analysis.
